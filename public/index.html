<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bases de datos del Gobierno de R√≠o Negro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #6c757d;
        }

        .tab.active {
            background: white;
            color: #4a90e2;
            border-bottom: 3px solid #4a90e2;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        /* Estilos para campos de texto personalizados (otros) */
        .custom-field {
            display: none;
            margin-top: 10px;
        }

        .custom-field.show {
            display: block;
        }

        .custom-field input {
            border-color: #28a745;
            background-color: #f8fff9;
        }

        .custom-field label {
            color: #28a745;
            font-style: italic;
        }

        .btn {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
@@ -639,510 +619,495 @@
    ]
};

// Funci√≥n para manejar selects con opci√≥n "otros"
function handleSelectChange(selectElement, customFieldId) {
    const customField = document.getElementById(customFieldId);
    const customInput = document.getElementById(customFieldId + '_text');
    if (selectElement.value === 'otros') {
        customField.classList.add('show');
        customInput.required = true;
        selectElement.setAttribute('data-original-value', selectElement.value);
    } else {
        customField.classList.remove('show');
        customInput.required = false;
        customInput.value = '';
    }
}

// -------- TAB MANAGEMENT --------
function showTab(tabName) {
    // Ocultar todas las pesta√±as y remover .active
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    // Mostrar la seleccionada
    const selectedTab = document.getElementById(tabName);
    const selectedButton = document.querySelector(`.tab[onclick="showTab('${tabName}')"]`);
    if (selectedTab) selectedTab.classList.add('active');
    if (selectedButton) selectedButton.classList.add('active');

    // Mostrar barra b√∫squeda global si corresponde
    document.getElementById('global-search').style.display =
        ['search', 'update', 'delete'].includes(tabName) ? 'block' : 'none';

    // Cargar campos si es necesario
    if (tabName === 'search') loadFieldsForSearch();
    if (['update', 'delete'].includes(tabName)) loadFieldsForGlobalSearch();
    if (tabName === 'delete') loadFieldsForDelete();

    // Si hay registro seleccionado para editar/eliminar, mostrarlo
    if (tabName === 'update' && currentEditingRow) showUpdateForm(currentEditingRow);
    if (tabName === 'delete' && currentDeletingRow) showDeleteConfirmation(currentDeletingRow);
}

document.getElementById('createForm').onsubmit = async function (e) {
  e.preventDefault();

  const formData = new FormData(this);
  const data = Object.fromEntries(formData.entries());

  try {
    const response = await fetch('/webhook/create', {
      method: 'POST', // Cambiado de GET a POST
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data),
    });

    const result = await response.json();
    if (result.success) {
      alert('Registro creado exitosamente');
    } else {
      alert('Error al crear el registro: ' + result.message);
    }
  } catch (err) {
    console.error('Error:', err);
    alert('Error al enviar el formulario');
  }
};

// -------- SEARCH TAB --------
async function loadAllRecords() {
    try {
        document.getElementById('search-records-container').innerHTML = '<div class="loading">Cargando registros...</div>';
        const response = await fetch(`${API_BASE}/webhook/read`);
        const result = await response.json();
        if (result.success) {
            currentRecords = result.data;
            displaySearchResults(result.data);
            updateSearchResultsInfo(`Mostrando todos los registros (${result.total} total)`);
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('Error loading records:', error);
        document.getElementById('search-records-container').innerHTML = 
            `<div class="error">Error al cargar registros: ${error.message}</div>`;
        showStatus(`‚ùå Error: ${error.message}`, 'error');
    }
}

async function loadFieldsForSearch() {
    try {
        const response = await fetch(`${API_BASE}/webhook/fields`);
        const result = await response.json();
        if (result.success) {
            searchFields = result.fields;
            populateSearchFieldSelect();
        }
    } catch (error) {
        console.error('Error loading fields:', error);
    }
}

function populateSearchFieldSelect() {
    const searchFieldSelect = document.getElementById('searchField');
    if (searchFieldSelect) {
        searchFieldSelect.innerHTML = '<option value="">Selecciona un campo...</option>';
        searchFields.forEach(field => {
            const option = document.createElement('option');
            option.value = field;
            option.textContent = field;
            searchFieldSelect.appendChild(option);
        });
    }
}

function displaySearchResults(records) {
    const container = document.getElementById('search-records-container');
    if (!records.length) {
        container.innerHTML = '<div class="no-records">No se encontraron registros.</div>';
        return;
    }
    container.innerHTML = '';
    records.forEach(record => {
        const div = document.createElement('div');
        div.className = 'record';
        div.innerHTML = Object.entries(record)
            .filter(([k]) => k !== '_rowIndex')
            .map(([k, v]) => `<strong>${k}:</strong> ${v || ''}`)
            .join('<br>');
        // Add Edit/Borrar buttons (use the _rowIndex for identification)
        if (typeof record._rowIndex !== 'undefined') {
            div.innerHTML += `<br>
                <button class="btn btn-success" onclick="editRecord(${record._rowIndex})">‚úèÔ∏è Editar</button>
                <button class="btn btn-danger" onclick="deleteRecord(${record._rowIndex})">üóëÔ∏è Borrar</button>
            `;
        }
        container.appendChild(div);
    });
}

function updateSearchResultsInfo(message) {
    const infoDiv = document.getElementById('searchResultsInfo');
    if (infoDiv) {
        infoDiv.innerHTML = `<div class="results-info">${message}</div>`;
        infoDiv.style.display = 'block';
    }
}

// -------- GLOBAL SEARCH (barra superior) --------
function loadFieldsForGlobalSearch() {
    fetch('/webhook/fields')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('globalSearchField');
                select.innerHTML = '<option value="">Selecciona un campo...</option>';
                data.fields.forEach(field => {
                    select.innerHTML += `<option value="${field}">${field}</option>`;
                });
                availableFields = data.fields;
            }
        })
        .catch(error => {
            console.error('Error loading fields:', error);
        });
}

function performGlobalSearch() {
    const searchText = document.getElementById('globalSearchText').value.trim();
    const searchField = document.getElementById('globalSearchField').value;
    if (!searchText || !searchField) {
        showStatus('Por favor, ingresa texto y selecciona un campo para buscar', 'error');
        return;
    }

    // Show loading status in the active tab
    const activeTabId = document.querySelector('.tab-content.active').id;
    if (activeTabId === 'update') {
        document.getElementById('update-records-container').innerHTML = '<div class="loading">Buscando...</div>';
    } else if (activeTabId === 'delete') {
        document.getElementById('delete-records').innerHTML = '<div class="loading">Buscando...</div>';
    }

    const url = `/webhook/search?searchText=${encodeURIComponent(searchText)}&searchField=${encodeURIComponent(searchField)}`;
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentRecords = data.data;

                // Display results based on active tab
                if (activeTabId === 'search') {
                    displaySearchResults(data.data);
                    updateSearchResultsInfo(`Se encontraron ${data.total} registro(s)`);
                } else if (activeTabId === 'update') {
                    displayUpdateResults(data.data);
                } else if (activeTabId === 'delete') {
                    displayDeleteResults(data.data);
                }

                showStatus(`Se encontraron ${data.total} registro(s)`, 'success');
            } else {
                showStatus('Error en la b√∫squeda: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showStatus('Error al realizar la b√∫squeda', 'error');
        });
}

function displayUpdateResults(records) {
    const container = document.getElementById('update-records-container');
    if (!records.length) {
        container.innerHTML = '<div class="no-records">No se encontraron registros.</div>';
        return;
    }
    container.innerHTML = '';
    records.forEach(record => {
        const div = document.createElement('div');
        div.className = 'record';
        div.innerHTML = Object.entries(record)
            .filter(([k]) => k !== '_rowIndex')
            .map(([k, v]) => `<strong>${k}:</strong> ${v || ''}`)
            .join('<br>');

        // Add Edit button
        if (typeof record._rowIndex !== 'undefined') {
            div.innerHTML += `<br>
                <button class="btn btn-success" onclick="editRecord(${record._rowIndex})">‚úèÔ∏è Editar</button>
            `;
        }
        container.appendChild(div);
    });
}

function displayDeleteResults(records) {
    const container = document.getElementById('delete-records');
    if (!records.length) {
        container.innerHTML = '<div class="no-records">No se encontraron registros.</div>';
        return;
    }
    container.innerHTML = '';
    records.forEach(record => {
        const div = document.createElement('div');
        div.className = 'record';
        div.innerHTML = Object.entries(record)
            .filter(([k]) => k !== '_rowIndex')
            .map(([k, v]) => `<strong>${k}:</strong> ${v || ''}`)
            .join('<br>');

        // Add Delete button
        if (typeof record._rowIndex !== 'undefined') {
            div.innerHTML += `<br>
                <button class="btn btn-danger" onclick="deleteRecord(${record._rowIndex})">üóëÔ∏è Borrar</button>
            `;
        }
        container.appendChild(div);
    });
}    

function clearGlobalSearch() {
    document.getElementById('globalSearchText').value = '';
    document.getElementById('globalSearchField').value = '';
    showStatus('B√∫squeda limpiada', 'info');
}
function loadAllGlobalRecords() {
    showStatus('Cargando todos los registros...', 'info');
    fetch('/webhook/read')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentRecords = data.data;
                displaySearchResults(data.data);
                updateSearchResultsInfo(`Se cargaron ${data.total} registro(s)`);
                document.getElementById('globalSearchText').value = '';
                document.getElementById('globalSearchField').value = '';
            } else {
                showStatus('Error al cargar registros: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showStatus('Error al cargar todos los registros', 'error');
        });
}

// -------- ADVANCED SEARCH --------
async function performAdvancedSearch() {
    const filters = collectAdvancedFilters();
    if (filters.length === 0) {
        showStatus('‚ùå Por favor, agrega al menos un filtro para la b√∫squeda avanzada.', 'error');
        return;
    }
    try {
        document.getElementById('search-records-container').innerHTML = '<div class="loading">Buscando...</div>';
        const response = await fetch(`${API_BASE}/webhook/search/advanced`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filters })
        });
        const result = await response.json();
        if (result.success) {
            currentRecords = result.data;
            displaySearchResults(result.data);
            updateSearchResultsInfo(`B√∫squeda avanzada con ${result.filtersApplied} filtro(s) - ${result.total} resultado(s) encontrado(s)`);
            showStatus(`üìã ${result.total} registros encontrados con b√∫squeda avanzada`, 'success');
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('Error in advanced search:', error);
        document.getElementById('search-records-container').innerHTML = 
            `<div class="error">Error en la b√∫squeda avanzada: ${error.message}</div>`;
        showStatus(`‚ùå Error: ${error.message}`, 'error');
    }
}
function addFilter() {
    if (!searchFields.length) {
        showStatus('‚ùå Primero carga los campos disponibles.', 'error');
        return;
    }
    const container = document.getElementById('filtersContainer');
    const filterId = `filter_${filterCount++}`;
    const filterHtml = `
        <div class="filter-row" id="${filterId}">
            <div class="filter-field">
                <label>Campo:</label>
                <select class="filter-field-select">
                    <option value="">Selecciona un campo...</option>
                    ${searchFields.map(field => `<option value="${field}">${field}</option>`).join('')}
                </select>
            </div>
            <div class="filter-operator">
                <label>Operador:</label>
                <select class="filter-operator-select">
                    <option value="contains">Contiene</option>
                    <option value="equals">Igual a</option>
                    <option value="startsWith">Comienza con</option>
                    <option value="endsWith">Termina con</option>
                    <option value="notEquals">Diferente de</option>
                </select>
            </div>
            <div class="filter-value">
                <label>Valor:</label>
                <input type="text" class="filter-value-input" placeholder="Valor a buscar...">
            </div>
            <div class="filter-actions">
                <button onclick="removeFilter('${filterId}')" class="btn btn-danger">‚ùå</button>
            </div>
        </div>
    `;
    container.innerHTML += filterHtml;
}
function removeFilter(filterId) {
    const el = document.getElementById(filterId);
    if (el) el.remove();
}
function collectAdvancedFilters() {
    const filters = [];
    const filterRows = document.querySelectorAll('#filtersContainer .filter-row');
    filterRows.forEach(row => {
        const field = row.querySelector('.filter-field-select').value;
        const operator = row.querySelector('.filter-operator-select').value;
        const value = row.querySelector('.filter-value-input').value.trim();
        if (field && value) {
            filters.push({ field, operator, value });
        }
    });
    return filters;
}
function clearAdvancedSearch() {
    document.getElementById('filtersContainer').innerHTML = '';
    filterCount = 0;
    const infoDiv = document.getElementById('searchResultsInfo');
    if (infoDiv) infoDiv.style.display = 'none';
    document.getElementById('search-records-container').innerHTML = 
        '<div class="loading">Haz clic en "Cargar Todos los Registros" o realiza una b√∫squeda</div>';
}

// -------- EDIT/UPDATE FLOW --------
function editRecord(rowIndex) {
    const rec = (currentRecords || []).find(r => r._rowIndex == rowIndex);
    if (!rec) return alert('No se encontr√≥ el registro');
    currentEditingRow = rec;
    showTab('update');
    showUpdateForm(rec);
}
function showUpdateForm(record) {
    document.getElementById('update-form-container').style.display = 'block';
    document.getElementById('update-rowIndex').value = record._rowIndex;
    // Dynamically create fields
    const fieldsDiv = document.getElementById('update-fields');
    fieldsDiv.innerHTML = '';
    Object.entries(record).forEach(([k, v]) => {
        if (k === '_rowIndex') return;
        fieldsDiv.innerHTML += `
            <div class="form-group">
                <label for="update-${k}">${k}:</label>
                <input type="text" id="update-${k}" name="${k}" value="${v || ''}">
            </div>
        `;
    });
}
// On submit updateForm, send to backend
document.getElementById('updateForm').onsubmit = async function(e) {
    e.preventDefault();
    const rowIndex = document.getElementById('update-rowIndex').value;
    const data = {};
    Array.from(this.elements).forEach(el => {
        if (el.name && el.type !== 'submit' && el.name !== 'rowIndex') {
            data[el.name] = el.value;
        }
    });
    try {
        const res = await fetch(`/webhook/update/${rowIndex}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) {
            showStatus('Registro actualizado correctamente', 'success');
            currentEditingRow = null;
            document.getElementById('update-form-container').style.display = 'none';
        } else {
            showStatus('Error al actualizar: ' + result.message, 'error');
        }
    } catch (err) {
        showStatus('Error en la actualizaci√≥n', 'error');
    }
}
function cancelUpdate() {
    currentEditingRow = null;
    document.getElementById('update-form-container').style.display = 'none';
}

// -------- DELETE FLOW --------
function deleteRecord(rowIndex) {
    const rec = (currentRecords || []).find(r => r._rowIndex == rowIndex);
    if (!rec) return alert('No se encontr√≥ el registro');
    currentDeletingRow = rec;
    showTab('delete');
    showDeleteConfirmation(rec);
}
function showDeleteConfirmation(record) {
    const div = document.getElementById('delete-records');
    div.innerHTML = `
        <div class="record">
        ${Object.entries(record).filter(([k]) => k !== '_rowIndex').map(([k, v]) => `<strong>${k}:</strong> ${v || ''}`).join('<br>')}
        </div>
        <div class="status-message error">
            ¬øSeguro que deseas eliminar este registro? Esta acci√≥n no se puede deshacer.
        </div>
        <button class="btn btn-danger" onclick="confirmDelete(${record._rowIndex})">S√≠, eliminar</button>
        <button class="btn btn-clear" onclick="cancelDelete()">Cancelar</button>
    `;
}
async function confirmDelete(rowIndex) {
    const record = currentDeletingRow;
    if (!record) return;
    try {
        // Usa el endpoint con searchCriteria por _rowIndex
        const res = await fetch('/webhook/delete', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ searchCriteria: { field: '_rowIndex', value: rowIndex } })
        });
        const result = await res.json();
        if (result.success) {
            showStatus('Registro eliminado correctamente', 'success');
            document.getElementById('delete-records').innerHTML = '';
            currentDeletingRow = null;
        } else {
            showStatus('Error al eliminar: ' + result.message, 'error');
        }
    } catch (err) {
        showStatus('Error en la eliminaci√≥n', 'error');
    }
}
function cancelDelete() {
    document.getElementById('delete-records').innerHTML = '';
    currentDeletingRow = null;
}

// -------- UTIL --------
function showStatus(msg, type) {
    const el = document.getElementById('status-message');
    el.innerHTML = msg;
    el.className = 'status-message ' + (type || '');
    setTimeout(() => { el.innerHTML = ''; el.className = 'status-message'; }, 3500);
}

// -------- INIT --------
function initializeGlobalSearch() {
    loadFieldsForGlobalSearch();
    const searchInput = document.getElementById('globalSearchText');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performGlobalSearch();
            }
        });
    }
}
document.addEventListener('DOMContentLoaded', initializeGlobalSearch);
</script>
</body></html>
