<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bases de datos del Gobierno de R√≠o Negro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #6c757d;
        }

        .tab.active {
            background: white;
            color: #4a90e2;
            border-bottom: 3px solid #4a90e2;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .btn-clear {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }

        .search-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .search-row {
            display: flex;
            gap: 10px;
            align-items: end;
            margin-bottom: 15px;
        }

        .search-field {
            flex: 2;
        }

        .search-dropdown {
            flex: 1;
        }

        .search-buttons {
            flex: 1;
        }

        .records-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-top: 20px;
        }

        .record {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .record:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .record:last-child {
            border-bottom: none;
        }
        
        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 8px;
        }
        
        .record-title {
            font-weight: bold;
            color: #4a90e2;
        }
        
        .record-buttons {
            display: flex;
            gap: 8px;
        }
        
        .record-content {
            margin-top: 10px;
        }
        
        .record .btn {
            padding: 6px 14px;
            font-size: 0.92rem;
            margin-right: 0;
            margin-bottom: 0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .delete-confirmation {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin: 20px 0;
        }
        
        .delete-confirmation h3 {
            color: #e74c3c;
            margin-bottom: 15px;
            border-bottom: 1px solid #f8d7da;
            padding-bottom: 10px;
        }
        
        .confirmation-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .filter-row {
            display: flex;
            gap: 10px;
            align-items: end;
            margin-bottom: 10px;
        }

        .filter-field, .filter-value {
            flex: 1;
        }

        .filter-operator {
            flex: 0.8;
        }

        .filter-actions {
            flex: 0.5;
        }

        /* Estilos para el mensaje de √©xito tras crear registro */
        .create-success {
            text-align: center;
            padding: 40px;
            background: #d4edda;
            border: 2px solid #c3e6cb;
            border-radius: 12px;
            margin: 20px 0;
        }

        .create-success h2 {
            color: #155724;
            margin-bottom: 20px;
            font-size: 2rem;
        }

        .create-success .success-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            display: block;
        }

        .create-success p {
            color: #155724;
            font-size: 1.2rem;
            margin-bottom: 30px;
        }

        .create-success .btn {
            margin: 0 10px;
            padding: 15px 30px;
            font-size: 1.1rem;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }

            .content {
                padding: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .search-row, .filter-row {
                flex-direction: column;
            }

            .search-field, .search-dropdown, .search-buttons,
            .filter-field, .filter-value, .filter-operator, .filter-actions {
                flex: none;
            }

            .create-success .btn {
                display: block;
                margin: 10px 0;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Gobierno de la Provincia R√≠o Negro</h1>
            <p>üóÑÔ∏è Sistema de gesti√≥n de bases de datos</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('create')">‚ûï Crear</button>
            <button class="tab" onclick="showTab('search')">üìã Buscar</button>
            <button class="tab" onclick="showTab('update')">‚úèÔ∏è Actualizar</button>
            <button class="tab" onclick="showTab('delete')">üóëÔ∏è Eliminar</button>
        </div>

        <div class="content">
            <div id="status-message"></div>

            <!-- Barra de b√∫squeda global -->
            <div id="global-search" class="search-container" style="display: none;">
                <h3>üîç Buscar Registros</h3>
                <div class="search-row">
                    <div class="search-field">
                        <label for="globalSearchText">Texto a buscar:</label>
                        <input type="text" id="globalSearchText" placeholder="Ingresa el texto a buscar...">
                    </div>
                    <div class="search-dropdown">
                        <label for="globalSearchField">Campo:</label>
                        <select id="globalSearchField">
                            <option value="">Selecciona un campo...</option>
                        </select>
                    </div>
                    <div class="search-buttons">
                        <button onclick="performGlobalSearch()" class="btn">üîç Buscar</button>
                        <button onclick="clearGlobalSearch()" class="btn btn-clear">üßπ Limpiar</button>
                        <button onclick="loadAllGlobalRecords()" class="btn btn-warning">üìã Ver Todos</button>
                        <button onclick="refreshFields()" class="btn" title="Actualizar campos">üîÑ Campos</button>
                    </div>
                </div>
            </div>

            <!-- CREATE TAB -->
            <div id="create" class="tab-content active">
                <!-- Formulario de creaci√≥n -->
                <div id="create-form-container">
                    <h2>Crear Nuevo Registro</h2>
                    <form id="createForm">
                      <div class="form-group">
                        <label for="Legajo">Legajo:</label>
                        <input type="text" id="Legajo" name="Legajo" required>
                      </div>
                      <div class="form-group">
                        <label for="Cooperativa">Cooperativa:</label>
                        <input type="text" id="Cooperativa" name="Cooperativa" required>
                      </div>
                      <div class="form-group">
                        <label for="Matr√≠cula">Matr√≠cula:</label>
                        <input type="text" id="Matr√≠cula" name="Matr√≠cula" required>
                      </div>
                      <div class="form-group">
                        <label for="ActaPcial">Acta provincial:</label>
                        <input type="text" id="ActaPcial" name="ActaPcial" required>
                      </div>
                      <div class="form-group">
                        <label for="EmisMat">Fecha de emisi√≥n matr√≠cula:</label>
                        <input type="date" id="EmisMat" name="EmisMat" required>
                      </div>
                      <div class="form-group">
                        <label for="Direcci√≥n">Direcci√≥n:</label>
                        <input type="text" id="Direcci√≥n" name="Direcci√≥n" required>
                      </div>
                      <div class="form-group">
                        <label for="Direcci√≥nVerificada">Direcci√≥n verificada:</label>
                        <input type="text" id="Direcci√≥nVerificada" name="Direcci√≥nVerificada" required>
                      </div>
                      <div class="form-group">
                        <label for="Tel">Tel√©fono:</label>
                        <input type="tel" id="Tel" name="Tel">
                      </div>
                      <div class="form-group">
                        <label for="Presid">Presidente:</label>
                        <input type="text" id="Presid" name="Presid" required>
                      </div> 
                      <div class="form-group">
                        <label for="Mail">Correo electr√≥nico:</label>
                        <input type="email" id="Mail" name="Mail" required>
                      </div> 
                      <div class="form-group">
                        <label for="EstadoEntid">Fecha Estado Entidad:</label>
                        <input type="date" id="EstadoEntid" name="EstadoEntid" required>
                      </div>                 
                      <div class="form-group">
                        <label for="FechaAsamb">Fecha Asamblea:</label>
                        <input type="date" id="FechaAsamb" name="FechaAsamb" required>
                      </div> 
                      <div class="form-group">
                        <label for="TipoAsamb">Tipo de asamblea:</label>
                        <select id="TipoAsamb" name="TipoAsamb" required>
                          <option value="">Seleccionar...</option>
                          <option value="Ordinaria">Ordinaria</option>
                          <option value="Ordinaria autoconvocada">Ordinaria autoconvocada</option>
                          <option value="Extraordinaria">Extraordinaria</option>
                          <option value="Extraordinaria autoconvocada">Extraordinaria autoconvocada</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label for="ConsejoAdmin">Consejo administrativo:</label>
                        <input type="text" id="ConsejoAdmin" name="ConsejoAdmin">
                      </div>
                      <div class="form-group">
                        <label for="Sindicatura">Sindicatura:</label>
                        <input type="text" id="Sindicatura" name="Sindicatura">
                      </div>                    
                      <div class="form-group">
                        <label for="Localidad">Localidad:</label>
                        <input type="text" id="Localidad" name="Localidad">
                      </div>
                      <div class="form-group">
                        <label for="Departamento">Departamento:</label>
                        <select id="Departamento" name="Departamento" required>
                          <option value="">Seleccionar departamento...</option>
                          <option value="Adolfo Alsina">Adolfo Alsina</option>
                          <option value="Avellaneda">Avellaneda</option>
                          <option value="Bariloche">Bariloche</option>
                          <option value="Conesa">Conesa</option>
                          <option value="El Cuy">El Cuy</option>
                          <option value="General Roca">General Roca</option>
                          <option value="9 de Julio">9 de Julio</option>
                          <option value="√ëorquinc√≥">√ëorquinc√≥</option>
                          <option value="Pichi Mahuida">Pichi Mahuida</option>
                          <option value="Pilcaniyeu">Pilcaniyeu</option>
                          <option value="San Antonio">San Antonio</option>
                          <option value="Valcheta">Valcheta</option>
                          <option value="25 de Mayo">25 de Mayo</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label for="CodPost">C√≥digo postal:</label>
                        <input type="text" id="CodPost" name="CodPost">
                      </div>
                      <div class="form-group">
                        <label for="Cuit">CUIT:</label>
                        <input type="text" id="Cuit" name="Cuit" placeholder="XX-XXXXXXXX-X" maxlength="13" pattern="[0-9]{2}-[0-9]{8}-[0-9]{1}">
                      </div>
                      <div class="form-group">
                        <label for="Tipo">Tipo:</label>
                        <select id="Tipo" name="Tipo" required>
                          <option value="">Seleccionar tipo...</option>
                          <option value="Agr√≠cola">Agr√≠cola</option>
                          <option value="Agr√≠cola-ganadera">Agr√≠cola-ganadera</option>
                          <option value="Consumo">Consumo</option>
                          <option value="Federaci√≥n">Federaci√≥n</option>
                          <option value="Frut√≠cola">Frut√≠cola</option>
                          <option value="Frutihort√≠cola">Frutihort√≠cola</option>
                          <option value="Ganadera">Ganadera</option>
                          <option value="Producci√≥n">Producci√≥n</option>
                          <option value="Provisi√≥n">Provisi√≥n</option>
                          <option value="Servicios">Servicios</option>
                          <option value="Servicios p√∫blicos">Servicios p√∫blicos</option>
                          <option value="Trabajo">Trabajo</option>
                          <option value="Vivienda">Vivienda</option>
                        </select>
                      </div>                
                      <div class="form-group">
                        <label for="Subtipo">Subtipo:</label>
                        <select id="Subtipo" name="Subtipo">
                          <option value="">Seleccionar subtipo...</option>
                          <option value="Atenci√≥n de personas">Atenci√≥n de personas</option>
                          <option value="Audiovisual">Audiovisual</option>
                          <option value="Bienes y servicios">Bienes y servicios</option>
                          <option value="Comercializaci√≥n e industrializaci√≥n">Comercializaci√≥n e industrializaci√≥n</option>
                          <option value="Comercializaci√≥n y consumo">Comercializaci√≥n y consumo</option>
                          <option value="Comercializaci√≥n y explotaci√≥n">Comercializaci√≥n y explotaci√≥n</option>
                          <option value="Comercializaci√≥n y producci√≥n">Comercializaci√≥n y producci√≥n</option>
                          <option value="Comercializaci√≥n y provisi√≥n">Comercializaci√≥n y provisi√≥n</option>
                          <option value="Comercializaci√≥n y transporte">Comercializaci√≥n y transporte</option>
                          <option value="Construcci√≥n">Construcci√≥n</option>
                          <option value="Construcci√≥n de estaciones transformadores de transmisi√≥n">Construcci√≥n de estaciones transformadores de transmisi√≥n</option>
                          <option value="Cultura">Cultura</option>
                          <option value="Dise√±o y producci√≥n">Dise√±o y producci√≥n</option>
                          <option value="Educativa">Educativa</option>
                          <option value="Empaque y embalaje de frutas">Empaque y embalaje de frutas</option>
                          <option value="Estacionamiento medido y pago">Estacionamiento medido y pago</option>
                          <option value="No aplica">No aplica</option>
                          <option value="Producci√≥n y consumo">Producci√≥n y consumo</option>
                          <option value="Radiodifusi√≥n">Radiodifusi√≥n</option>
                          <option value="Rurales">Rurales</option>
                        </select>
                      </div>                    
                      <div class="form-group">
                        <label for="Observaciones">Observaciones:</label>
                        <textarea id="Observaciones" name="Observaciones" rows="3"></textarea>
                      </div>
                      <div class="form-group">
                        <label for="Latitud">Latitud:</label>
                        <input type="text" id="Latitud" name="Latitud">
                      </div>
                      <div class="form-group">
                        <label for="Longitud">Longitud:</label>
                        <input type="text" id="Longitud" name="Longitud">
                      </div>
                      <button type="submit" class="btn">Crear Registro</button>
                    </form>
                </div>

                <!-- Mensaje de √©xito tras crear registro -->
                <div id="create-success-container" style="display: none;">
                    <div class="create-success">
                        <span class="success-icon">‚úÖ</span>
                        <h2>¬°Registro creado exitosamente!</h2>
                        <p>El registro se ha guardado correctamente en la base de datos.</p>
                        <div>
                            <button onclick="createAnotherRecord()" class="btn btn-success">‚ûï Crear otro registro</button>
                            <button onclick="viewAllRecords()" class="btn btn-warning">üìã Ver registros cargados</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SEARCH TAB -->
            <div id="search" class="tab-content">
                <h2>Buscar Registros Existentes</h2>
                
                <!-- Controles principales -->
                <div style="margin: 20px 0;">
                    <button onclick="loadAllRecords()" class="btn">üìã Cargar Todos los Registros</button>
                </div>

                <!-- Contenedor de registros -->
                <div id="search-records-container" class="records-container">
                    <div class="loading">Haz clic en "Cargar Todos los Registros" o realiza una b√∫squeda</div>
                </div>
            </div>

            <!-- UPDATE TAB -->
            <div id="update" class="tab-content">
                <h2>Actualizar Registro</h2>

                <!-- Formulario de actualizaci√≥n -->
                <div id="update-form-container" style="display: none;">
                    <h3>‚úèÔ∏è Editando Registro</h3>
                    <form id="updateForm">
                        <input type="hidden" id="update-Legajo" name="Legajo">
                        <div id="update-fields"></div>
                        <div style="margin-top: 20px;">
                            <button type="submit" class="btn">üíæ Guardar Cambios</button>
                            <button type="button" onclick="cancelUpdate()" class="btn btn-clear">‚ùå Cancelar</button>
                        </div>
                    </form>
                </div>

                <!-- Contenedor de registros para actualizar -->
                <div id="update-records-container" class="records-container">
                    <div class="loading">Usa la barra de b√∫squeda de arriba para encontrar registros</div>
                </div>
            </div>

            <!-- DELETE TAB -->
            <div id="delete" class="tab-content">
                <h2>Eliminar Registro</h2>
                <div id="delete-records" class="records-container">
                    <div class="loading">Usa la barra de b√∫squeda de arriba para encontrar registros</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        // Variables globales
        let currentRecords = [];
        let availableFields = [];
        let currentEditingRow = null;
        let currentDeletingRow = null;

        // -------- TAB MANAGEMENT --------
        function showTab(tabName) {
            console.log('Cambiando a pesta√±a:', tabName);
            
            // Ocultar todas las pesta√±as y remover .active
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            // Mostrar la seleccionada
            const selectedTab = document.getElementById(tabName);
            const selectedButton = document.querySelector(`.tab[onclick="showTab('${tabName}')"]`);
            
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            if (selectedButton) {
                selectedButton.classList.add('active');
            }

            // Mostrar barra b√∫squeda global si corresponde
            const globalSearch = document.getElementById('global-search');
            if (['search', 'update', 'delete'].includes(tabName)) {
                globalSearch.style.display = 'block';
                loadFieldsForGlobalSearch();
            } else {
                globalSearch.style.display = 'none';
            }

            // Resetear contenedores al cambiar de pesta√±a
            if (tabName === 'update') {
                document.getElementById('update-form-container').style.display = 'none';
                document.getElementById('update-records-container').style.display = 'block';
            }

            // Si cambiamos a create, asegurar que se muestre el formulario
            if (tabName === 'create') {
                showCreateForm();
            }
        }

        // -------- CREATE FORM FUNCTIONS --------
        function showCreateForm() {
            document.getElementById('create-form-container').style.display = 'block';
            document.getElementById('create-success-container').style.display = 'none';
            document.getElementById('status-message').innerHTML = '';
        }

        function showCreateSuccess() {
            document.getElementById('create-form-container').style.display = 'none';
            document.getElementById('create-success-container').style.display = 'block';
            document.getElementById('status-message').innerHTML = '';
        }

        function createAnotherRecord() {
            // Limpiar el formulario y volver a mostrarlo
            document.getElementById('createForm').reset();
            showCreateForm();
        }

        function viewAllRecords() {
            // Cambiar a la pesta√±a de buscar y cargar todos los registros
            showTab('search');
            loadAllRecords();
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('createForm').addEventListener('submit', async function(e) {
                e.preventDefault();

                const formData = new FormData(this);
                const data = Object.fromEntries(formData.entries());

                try {
                    showStatus('Creando registro...', 'info');
                    
                    const response = await fetch(`${API_BASE}/webhook/create`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data),
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        // Mostrar mensaje de √©xito con botones
                        showCreateSuccess();
                        
                        // Opcional: mostrar un status temporal
                        setTimeout(() => {
                            showStatus('', 'info'); // Limpiar status
                        }, 1000);
                    } else {
                        showStatus('Error al crear el registro: ' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showStatus('Error al enviar el formulario: ' + error.message, 'error');
                }
            });
        });

        // -------- SEARCH FUNCTIONS --------
        async function loadAllRecords() {
            try {
                showStatus('Cargando registros...', 'info');
                document.getElementById('search-records-container').innerHTML = '<div class="loading">Cargando registros...</div>';
                
                const response = await fetch(`${API_BASE}/webhook/read`);
                const result = await response.json();
                
                if (result.success) {
                    currentRecords = result.data;
                    displaySearchResults(result.data);
                    showStatus(`${result.total} registros cargados`, 'success');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error loading records:', error);
                document.getElementById('search-records-container').innerHTML = 
                    `<div class="error">Error al cargar registros: ${error.message}</div>`;
                showStatus('Error al cargar registros: ' + error.message, 'error');
            }
        }

        function displaySearchResults(records) {
            // Determinar pesta√±a activa y contenedor
            const activeTab = document.querySelector('.tab-content.active').id;
            let container;
            
            if (activeTab === 'search') {
                container = document.getElementById('search-records-container');
            } else if (activeTab === 'update') {
                container = document.getElementById('update-records-container');
            } else if (activeTab === 'delete') {
                container = document.getElementById('delete-records');
            }
            
            if (!container) return;
            
            if (!records.length) {
                container.innerHTML = '<div class="loading">No se encontraron registros.</div>';
                return;
            }

            container.innerHTML = '';
            
            records.forEach(record => {
                const div = document.createElement('div');
                div.className = 'record';
                
                const legajo = record.Legajo || record._Legajo;
                
                // Definir botones seg√∫n la pesta√±a activa
                let buttons = '';
                if (activeTab === 'search') {
                    buttons = `
                        <button class="btn btn-success" onclick="editRecord('${legajo}')">‚úèÔ∏è Editar</button>
                        <button class="btn btn-danger" onclick="deleteRecord('${legajo}')">üóëÔ∏è Borrar</button>
                    `;
                } else if (activeTab === 'update') {
                    buttons = `
                        <button class="btn btn-success" onclick="editRecord('${legajo}')">‚úèÔ∏è Editar</button>
                    `;
                } else if (activeTab === 'delete') {
                    buttons = `
                        <button class="btn btn-danger" onclick="deleteRecord('${legajo}')">üóëÔ∏è Borrar</button>
                    `;
                }
                
                div.innerHTML = `
                    <div class="record-header">
                        <div class="record-title">Registro #${legajo || 'S/N'}</div>
                        <div class="record-buttons">
                            ${buttons}
                        </div>
                    </div>
                    <div class="record-content">
                        ${Object.entries(record)
                            .filter(([k]) => k !== '_Legajo' && k !== '_rowIndex')
                            .map(([k, v]) => `<strong>${k}:</strong> ${v || ''}`)
                            .join('<br>')}
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        // -------- GLOBAL SEARCH (CORREGIDA) --------
        async function loadFieldsForGlobalSearch() {
            try {
                console.log('Cargando campos din√°micamente...');
                
                // Corregir: usar el endpoint correcto que s√≠ existe
                const response = await fetch(`${API_BASE}/webhook/fields`);
                const result = await response.json();
                
                if (result.success && result.fields) {
                    const fields = result.fields;
                    
                    const select = document.getElementById('globalSearchField');
                    if (select) {
                        select.innerHTML = '<option value="">Selecciona un campo...</option>';
                        fields.forEach(field => {
                            select.innerHTML += `<option value="${field}">${field}</option>`;
                        });
                        availableFields = fields;
                        
                        console.log('Campos cargados correctamente:', fields);
                    }
                } else {
                    throw new Error('No se pudieron obtener los campos');
                }
            } catch (error) {
                console.error('Error cargando campos:', error);
                
                // Fallback a campos predefinidos
                const fallbackFields = [
                    'Legajo', 'Cooperativa', 'Matr√≠cula', 'ActaPcial', 'EmisMat', 'Direcci√≥n',
                    'Direcci√≥nVerificada', 'Tel', 'Presid', 'Mail', 'EstadoEntid', 'FechaAsamb',
                    'TipoAsamb', 'ConsejoAdmin', 'Sindicatura', 'Localidad', 'Departamento',
                    'CodPost', 'Cuit', 'Tipo', 'Subtipo', 'Observaciones', 'Latitud', 'Longitud'
                ];
                
                const select = document.getElementById('globalSearchField');
                if (select) {
                    select.innerHTML = '<option value="">Selecciona un campo...</option>';
                    fallbackFields.forEach(field => {
                        select.innerHTML += `<option value="${field}">${field}</option>`;
                    });
                    availableFields = fallbackFields;
                    
                    console.log('Usando campos fallback:', fallbackFields);
                }
                
                showStatus('Usando campos predeterminados', 'info');
            }
        }
        
        async function refreshFields() {
            await loadFieldsForGlobalSearch();
            showStatus('Campos actualizados', 'success');
        }
        
        async function performGlobalSearch() {
            const searchText = document.getElementById('globalSearchText').value.trim();
            const searchField = document.getElementById('globalSearchField').value;
            
            if (!searchText || !searchField) {
                showStatus('Por favor, ingresa texto y selecciona un campo para buscar', 'error');
                return;
            }

            try {
                showStatus('Buscando...', 'info');
                
                // Determinar contenedor seg√∫n pesta√±a activa
                const activeTab = document.querySelector('.tab-content.active').id;
                let container;
                
                if (activeTab === 'search') {
                    container = document.getElementById('search-records-container');
                } else if (activeTab === 'update') {
                    container = document.getElementById('update-records-container');
                } else if (activeTab === 'delete') {
                    container = document.getElementById('delete-records');
                }
                
                if (container) {
                    container.innerHTML = '<div class="loading">Buscando...</div>';
                }

                const url = `${API_BASE}/webhook/search?searchText=${encodeURIComponent(searchText)}&searchField=${encodeURIComponent(searchField)}`;
                console.log('Enviando b√∫squeda a:', url);
                
                const response = await fetch(url);
                const result = await response.json();

                console.log('Respuesta de b√∫squeda:', result);

                if (result.success) {
                    currentRecords = result.data;
                    displaySearchResults(result.data);
                    showStatus(`Se encontraron ${result.total} registro(s)`, 'success');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error en b√∫squeda:', error);
                showStatus('Error al realizar la b√∫squeda: ' + error.message, 'error');
                
                // Mostrar error en el contenedor activo
                const activeTab = document.querySelector('.tab-content.active').id;
                let container;
                
                if (activeTab === 'search') {
                    container = document.getElementById('search-records-container');
                } else if (activeTab === 'update') {
                    container = document.getElementById('update-records-container');
                } else if (activeTab === 'delete') {
                    container = document.getElementById('delete-records');
                }
                
                if (container) {
                    container.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                }
            }
        }

        function clearGlobalSearch() {
            document.getElementById('globalSearchText').value = '';
            document.getElementById('globalSearchField').value = '';
            showStatus('B√∫squeda limpiada', 'info');
        }

        function loadAllGlobalRecords() {
            // Cargar todos los registros y mostrarlos en la pesta√±a activa
            const activeTab = document.querySelector('.tab-content.active').id;
            
            if (activeTab === 'search') {
                loadAllRecords();
            } else {
                // Para pesta√±as update y delete, cargar registros
                loadAllRecordsForCurrentTab();
            }
        }

        async function loadAllRecordsForCurrentTab() {
            try {
                showStatus('Cargando registros...', 'info');
                
                const response = await fetch(`${API_BASE}/webhook/read`);
                const result = await response.json();
                
                if (result.success) {
                    currentRecords = result.data;
                    displaySearchResults(result.data);
                    showStatus(`${result.total} registros cargados`, 'success');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error loading records:', error);
                showStatus('Error al cargar registros: ' + error.message, 'error');
            }
        }

        // -------- UPDATE FUNCTIONS --------
        function editRecord(legajo) {
            console.log('Editando registro con Legajo:', legajo);
            
            const record = currentRecords.find(r => (r.Legajo || r._Legajo) == legajo);
            if (!record) {
                showStatus('No se encontr√≥ el registro con Legajo: ' + legajo, 'error');
                return;
            }
            
            currentEditingRow = record;
            showTab('update');
            showUpdateForm(record);
        }

        function showUpdateForm(record) {
            document.getElementById('update-form-container').style.display = 'block';
            document.getElementById('update-records-container').style.display = 'none';
            
            const legajo = record.Legajo || record._Legajo;
            document.getElementById('update-Legajo').value = legajo;
            
            const fieldsContainer = document.getElementById('update-fields');
            fieldsContainer.innerHTML = '';
            
            // Crear campos para edici√≥n
            Object.entries(record).forEach(([key, value]) => {
                if (key === '_Legajo' || key === '_rowIndex') return;
                
                const fieldId = `update-${key.replace(/\s+/g, '_')}`;
                const fieldHtml = `
                    <div class="form-group">
                        <label for="${fieldId}">${key}:</label>
                        <input type="text" id="${fieldId}" name="${key}" value="${value || ''}">
                    </div>
                `;
                fieldsContainer.innerHTML += fieldHtml;
            });
        }

        function cancelUpdate() {
            document.getElementById('update-form-container').style.display = 'none';
            document.getElementById('update-records-container').style.display = 'block';
            currentEditingRow = null;
            showTab('search');
        }

        // -------- DELETE FUNCTIONS --------
        function deleteRecord(legajo) {
            console.log('Eliminando registro con Legajo:', legajo);
            
            const record = currentRecords.find(r => (r.Legajo || r._Legajo) == legajo);
            if (!record) {
                showStatus('No se encontr√≥ el registro con Legajo: ' + legajo, 'error');
                return;
            }
            
            currentDeletingRow = record;
            showTab('delete');
            showDeleteConfirmation(record);
        }

        function showDeleteConfirmation(record) {
            const container = document.getElementById('delete-records');
            const legajo = record.Legajo || record._Legajo;
            
            container.innerHTML = `
                <div class="delete-confirmation">
                    <h3>üóëÔ∏è Eliminar Registro #${legajo}</h3>
                    
                    <div class="record">
                        ${Object.entries(record)
                            .filter(([k]) => k !== '_Legajo' && k !== '_rowIndex')
                            .map(([k, v]) => `<strong>${k}:</strong> ${v || ''}`)
                            .join('<br>')}
                    </div>
                    
                    <div class="status-message error">
                        <p>¬øEst√°s seguro que deseas eliminar este registro? Esta acci√≥n no se puede deshacer.</p>
                    </div>
                    
                    <div class="confirmation-buttons">
                        <button class="btn btn-danger" onclick="confirmDelete('${legajo}')">S√≠, eliminar</button>
                        <button class="btn btn-clear" onclick="cancelDelete()">Cancelar</button>
                    </div>
                </div>
            `;
        }

        async function confirmDelete(legajo) {
            try {
                showStatus('Eliminando registro...', 'info');
                
                const response = await fetch(`${API_BASE}/webhook/delete`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        searchCriteria: { 
                            field: 'Legajo',  
                            value: legajo 
                        } 
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus('Registro eliminado correctamente', 'success');
                    document.getElementById('delete-records').innerHTML = '';
                    currentDeletingRow = null;
                    showTab('search');
                    loadAllRecords();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error en la eliminaci√≥n:', error);
                showStatus('Error al eliminar: ' + error.message, 'error');
            }
        }

        function cancelDelete() {
            currentDeletingRow = null;
            document.getElementById('delete-records').innerHTML = '';
            showTab('search');
            showStatus('Eliminaci√≥n cancelada', 'info');
        }

        // -------- UPDATE FORM HANDLER --------
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('updateForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const data = Object.fromEntries(formData.entries());
                const legajo = data.Legajo;
                
                try {
                    showStatus('Guardando cambios...', 'info');
                    
                    const response = await fetch(`${API_BASE}/webhook/update`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            searchCriteria: { field: 'Legajo', value: legajo },
                            updateData: data
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showStatus('Registro actualizado correctamente', 'success');
                        cancelUpdate();
                        loadAllRecords();
                    } else {
                        throw new Error(result.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showStatus('Error al actualizar: ' + error.message, 'error');
                }
            });
        });

        // -------- UTILITY FUNCTIONS --------
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.innerHTML = `<div class="status-message ${type}">${message}</div>`;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        // Inicializar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('P√°gina cargada, inicializando...');
            showTab('create');
        });
    </script>
</body>
</html>
