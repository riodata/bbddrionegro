<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Gobierno de R√≠o Negro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }

        .admin-header {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-header h1 {
            font-size: 2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            text-align: right;
            font-size: 0.9rem;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 8px;
            transition: background 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .admin-nav {
            background: #34495e;
            padding: 0;
            display: flex;
            overflow-x: auto;
        }

        .admin-tab {
            background: none;
            border: none;
            color: white;
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-size: 1rem;
            border-bottom: 3px solid transparent;
        }

        .admin-tab:hover {
            background: rgba(255,255,255,0.1);
        }

        .admin-tab.active {
            background: rgba(255,255,255,0.2);
            border-bottom-color: #e74c3c;
        }

        .admin-content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Audit Dashboard Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #3498db;
        }

        .stat-card.create { border-left-color: #2ecc71; }
        .stat-card.update { border-left-color: #f39c12; }
        .stat-card.delete { border-left-color: #e74c3c; }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .stat-period {
            color: #95a5a6;
            font-size: 0.9rem;
        }

        /* Filters */
        .filters-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-export {
            background: #27ae60;
            color: white;
        }

        /* Audit Table */
        .audit-table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .audit-table {
            width: 100%;
            border-collapse: collapse;
        }

        .audit-table th {
            background: #34495e;
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
        }

        .audit-table td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
        }

        .audit-table tr:hover {
            background: #f8f9fa;
        }

        .action-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .action-create { background: #d4edda; color: #155724; }
        .action-update { background: #fff3cd; color: #856404; }
        .action-delete { background: #f8d7da; color: #721c24; }
        .action-read { background: #d1ecf1; color: #0c5460; }

        .details-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .details-btn:hover {
            background: #138496;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80%;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .close-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .json-display {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .audit-table {
                font-size: 0.85rem;
            }

            .modal-content {
                margin: 10% auto;
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="admin-header">
            <h1>
                <span>üõ°Ô∏è</span>
                Panel de Administraci√≥n
            </h1>
            <div class="user-info">
                <div id="admin-user-details"></div>
                <button onclick="logout()" class="logout-btn">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <!-- Navigation -->
        <div class="admin-nav">
            <button class="admin-tab active" onclick="showAdminTab('audit')">
                üìä Auditor√≠a de Sistema
            </button>
            <button class="admin-tab" onclick="showAdminTab('users')">
                üë• Gesti√≥n de Usuarios
            </button>
            <button class="admin-tab" onclick="showAdminTab('tables')">
                üóÉÔ∏è Gesti√≥n de Tablas
            </button>
            <button class="admin-tab" onclick="showAdminTab('reports')">
                üìà Reportes
            </button>
            <button class="admin-tab" onclick="showAdminTab('main-app')">
                üè† Aplicaci√≥n Principal
            </button>
        </div>

        <!-- Content -->
        <div class="admin-content">
            <!-- Audit Tab -->
            <div id="audit" class="tab-content active">
                <!-- Statistics -->
                <div class="stats-grid" id="audit-stats">
                    <!-- Statistics will be loaded here -->
                </div>

                <!-- Filters -->
                <div class="filters-section">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">üîç Filtros de B√∫squeda</h3>
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label for="user-filter">Usuario (Email)</label>
                            <input type="email" id="user-filter" placeholder="usuario@ejemplo.com">
                        </div>
                        <div class="filter-group">
                            <label for="table-filter">Tabla</label>
                            <select id="table-filter">
                                <option value="">Todas las tablas</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="action-filter">Acci√≥n</label>
                            <select id="action-filter">
                                <option value="">Todas las acciones</option>
                                <option value="CREATE">Crear</option>
                                <option value="UPDATE">Actualizar</option>
                                <option value="DELETE">Eliminar</option>
                                <option value="READ">Leer</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="date-from">Fecha Desde</label>
                            <input type="datetime-local" id="date-from">
                        </div>
                        <div class="filter-group">
                            <label for="date-to">Fecha Hasta</label>
                            <input type="datetime-local" id="date-to">
                        </div>
                    </div>
                    <div class="filter-actions">
                        <button class="btn btn-primary" onclick="loadAuditLogs()">
                            üîç Aplicar Filtros
                        </button>
                        <button class="btn btn-secondary" onclick="clearFilters()">
                            üßπ Limpiar Filtros
                        </button>
                        <button class="btn btn-export" onclick="exportAuditLogs()">
                            üì• Exportar CSV
                        </button>
                    </div>
                </div>

                <!-- Audit Table -->
                <div class="audit-table-container">
                    <table class="audit-table">
                        <thead>
                            <tr>
                                <th>Fecha/Hora</th>
                                <th>Usuario</th>
                                <th>Acci√≥n</th>
                                <th>Tabla</th>
                                <th>Registro ID</th>
                                <th>IP</th>
                                <th>Detalles</th>
                            </tr>
                        </thead>
                        <tbody id="audit-table-body">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Other tabs content -->
            <div id="users" class="tab-content">
                <h2>üë• Gesti√≥n de Usuarios</h2>
                <p>Funcionalidad de gesti√≥n de usuarios en desarrollo...</p>
            </div>

            <div id="tables" class="tab-content">
                <h2>üóÉÔ∏è Gesti√≥n de Tablas</h2>
                <p>Funcionalidad de gesti√≥n de tablas en desarrollo...</p>
            </div>

            <div id="reports" class="tab-content">
                <h2>üìà Reportes</h2>
                <p>Funcionalidad de reportes en desarrollo...</p>
            </div>

            <div id="main-app" class="tab-content">
                <h2>üè† Aplicaci√≥n Principal</h2>
                <p>Ir a la aplicaci√≥n principal del sistema...</p>
                <button class="btn btn-primary" onclick="window.location.href='index.html'">
                    Ir a Aplicaci√≥n Principal
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for details -->
    <div id="details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Detalles de Auditor√≠a</h3>
                <button class="close-btn" onclick="closeModal()">‚úï</button>
            </div>
            <div id="modal-body">
                <!-- Details content -->
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let currentUser = null;
        let authToken = null;
        let currentAuditData = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAuth();
        });

        // Check admin authentication
        function checkAdminAuth() {
            authToken = localStorage.getItem('authToken');
            const userStr = localStorage.getItem('user');
            
            if (!authToken || !userStr) {
                window.location.href = 'index.html';
                return;
            }

            try {
                currentUser = JSON.parse(userStr);
                
                if (currentUser.rol !== 'admin') {
                    alert('Acceso denegado. Se requieren permisos de administrador.');
                    window.location.href = 'index.html';
                    return;
                }
                
                showAdminUserInfo();
                loadInitialData();
            } catch (e) {
                console.error('Error procesando datos de usuario:', e);
                window.location.href = 'index.html';
            }
        }

        // Show admin user info
        function showAdminUserInfo() {
            if (currentUser) {
                document.getElementById('admin-user-details').innerHTML = `
                    <div>üë§ ${currentUser.nombre_apellido}</div>
                    <div>üìß ${currentUser.email}</div>
                    <div>üõ°Ô∏è Administrador</div>
                `;
            }
        }

        // Load initial data
        async function loadInitialData() {
            await Promise.all([
                loadAuditStats(),
                loadTablesList(),
                loadAuditLogs()
            ]);
        }

        // Tab management
        function showAdminTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.admin-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Load audit statistics
        async function loadAuditStats() {
            try {
                const response = await authenticatedFetch(`${API_BASE}/api/admin/audit-stats`);
                const result = await response.json();
                
                if (result.success) {
                    displayAuditStats(result.data);
                }
            } catch (error) {
                console.error('Error loading audit stats:', error);
            }
        }

        // Display audit statistics
        function displayAuditStats(stats) {
            const statsContainer = document.getElementById('audit-stats');
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total || 0}</div>
                    <div class="stat-label">Total de Acciones</div>
                    <div class="stat-period">Todas las fechas</div>
                </div>
                <div class="stat-card create">
                    <div class="stat-number">${stats.creates || 0}</div>
                    <div class="stat-label">Registros Creados</div>
                    <div class="stat-period">√öltimo mes</div>
                </div>
                <div class="stat-card update">
                    <div class="stat-number">${stats.updates || 0}</div>
                    <div class="stat-label">Registros Actualizados</div>
                    <div class="stat-period">√öltimo mes</div>
                </div>
                <div class="stat-card delete">
                    <div class="stat-number">${stats.deletes || 0}</div>
                    <div class="stat-label">Registros Eliminados</div>
                    <div class="stat-period">√öltimo mes</div>
                </div>
            `;
        }

        // Load tables list for filter
        async function loadTablesList() {
            try {
                const response = await authenticatedFetch(`${API_BASE}/api/admin/tables`);
                const result = await response.json();
                
                if (result.success) {
                    const select = document.getElementById('table-filter');
                    result.data.forEach(table => {
                        const option = document.createElement('option');
                        option.value = table;
                        option.textContent = table;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading tables:', error);
            }
        }

        // Load audit logs
        async function loadAuditLogs() {
            try {
                const filters = getFilters();
                const queryString = new URLSearchParams(filters).toString();
                
                const response = await authenticatedFetch(`${API_BASE}/api/admin/audit-logs?${queryString}`);
                const result = await response.json();
                
                if (result.success) {
                    currentAuditData = result.data;
                    displayAuditLogs(result.data);
                }
            } catch (error) {
                console.error('Error loading audit logs:', error);
                document.getElementById('audit-table-body').innerHTML = `
                    <tr><td colspan="7" class="no-data">Error cargando datos de auditor√≠a</td></tr>
                `;
            }
        }

        // Get current filters
        function getFilters() {
            const filters = {};
            
            const userFilter = document.getElementById('user-filter').value;
            if (userFilter) filters.user_email = userFilter;
            
            const tableFilter = document.getElementById('table-filter').value;
            if (tableFilter) filters.table_name = tableFilter;
            
            const actionFilter = document.getElementById('action-filter').value;
            if (actionFilter) filters.action = actionFilter;
            
            const dateFrom = document.getElementById('date-from').value;
            if (dateFrom) filters.date_from = dateFrom;
            
            const dateTo = document.getElementById('date-to').value;
            if (dateTo) filters.date_to = dateTo;
            
            return filters;
        }

        // Display audit logs
        function displayAuditLogs(logs) {
            const tbody = document.getElementById('audit-table-body');
            
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">No se encontraron registros de auditor√≠a</td></tr>';
                return;
            }
            
            tbody.innerHTML = logs.map(log => `
                <tr>
                    <td>${formatDateTime(log.timestamp)}</td>
                    <td>
                        <strong>${log.user_name || 'N/A'}</strong><br>
                        <small>${log.user_email}</small>
                    </td>
                    <td>
                        <span class="action-badge action-${log.action.toLowerCase()}">
                            ${log.action}
                        </span>
                    </td>
                    <td>${log.table_name}</td>
                    <td>${log.record_id || 'N/A'}</td>
                    <td>${log.ip_address || 'N/A'}</td>
                    <td>
                        <button class="details-btn" onclick="showDetails(${log.id})">
                            Ver Detalles
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Show details modal
        function showDetails(logId) {
            const log = currentAuditData.find(l => l.id === logId);
            if (!log) return;
            
            document.getElementById('modal-title').textContent = `Detalles de ${log.action} - ${log.table_name}`;
            
            document.getElementById('modal-body').innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4>Informaci√≥n General</h4>
                    <p><strong>Usuario:</strong> ${log.user_name} (${log.user_email})</p>
                    <p><strong>Fecha:</strong> ${formatDateTime(log.timestamp)}</p>
                    <p><strong>IP:</strong> ${log.ip_address || 'N/A'}</p>
                    <p><strong>Tabla:</strong> ${log.table_name}</p>
                    <p><strong>Registro ID:</strong> ${log.record_id || 'N/A'}</p>
                </div>
                
                ${log.old_values ? `
                    <div style="margin-bottom: 20px;">
                        <h4>Valores Anteriores</h4>
                        <div class="json-display">${formatJSON(log.old_values)}</div>
                    </div>
                ` : ''}
                
                ${log.new_values ? `
                    <div style="margin-bottom: 20px;">
                        <h4>Valores Nuevos</h4>
                        <div class="json-display">${formatJSON(log.new_values)}</div>
                    </div>
                ` : ''}
            `;
            
            document.getElementById('details-modal').style.display = 'block';
        }

        // Close modal
        function closeModal() {
            document.getElementById('details-modal').style.display = 'none';
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('user-filter').value = '';
            document.getElementById('table-filter').value = '';
            document.getElementById('action-filter').value = '';
            document.getElementById('date-from').value = '';
            document.getElementById('date-to').value = '';
            loadAuditLogs();
        }

        // Export audit logs
        function exportAuditLogs() {
            if (currentAuditData.length === 0) {
                alert('No hay datos para exportar');
                return;
            }
            
            const csv = generateCSV(currentAuditData);
            downloadCSV(csv, `audit_logs_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // Generate CSV
        function generateCSV(data) {
            const headers = ['Fecha/Hora', 'Usuario', 'Email', 'Acci√≥n', 'Tabla', 'Registro ID', 'IP'];
            const rows = data.map(log => [
                formatDateTime(log.timestamp),
                log.user_name || '',
                log.user_email,
                log.action,
                log.table_name,
                log.record_id || '',
                log.ip_address || ''
            ]);
            
            return [headers, ...rows].map(row => 
                row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
            ).join('\n');
        }

        // Download CSV
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Utility functions
        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleString('es-AR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            } catch (error) {
                return dateString;
            }
        }

        function formatJSON(jsonString) {
            try {
                const obj = typeof jsonString === 'string' ? JSON.parse(jsonString) : jsonString;
                return JSON.stringify(obj, null, 2);
            } catch (error) {
                return jsonString;
            }
        }

        // Authenticated fetch
        async function authenticatedFetch(url, options = {}) {
            const token = localStorage.getItem('authToken');
            
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };

            const finalOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...(options.headers || {})
                }
            };

            const response = await fetch(url, finalOptions);
            
            if (response.status === 401) {
                localStorage.removeItem('authToken');
                localStorage.removeItem('user');
                window.location.href = 'index.html';
                throw new Error('Sesi√≥n expirada');
            }

            return response;
        }

        // Logout
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('details-modal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
